from __future__ import print_function
import os
from flask import Flask, flash, request, redirect, url_for, session
import sys
from werkzeug.utils import secure_filename
from flask_cors import CORS, cross_origin
import logging
import matplotlib as mpl
import matplotlib.pylab as plt
import numpy as np
import math
from PIL import Image
from tensorflow.keras.models import load_model
from keras.preprocessing import image
import cv2


logging.basicConfig(level=logging.INFO)

logger = logging.getLogger('HELLO WORLD')


UPLOAD_FOLDER = '/upload'
ALLOWED_EXTENSIONS = set(['txt', 'pdf', 'png', 'jpg', 'jpeg', 'gif','docx','hwp','ppt','pptx','exe','h5'])

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
CORS(app, support_credentials=True)

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def print_hex_dump(buffer, start_offset=0):
    offset = 0
    while offset < len(buffer):
        #Offset
        print(' %08X ' % (offset + start_offset), end='')
        if ((len(buffer) - offset) < 0x10) is True:
            data = buffer[offset:]
        else:
            data = buffer[offset:offset + 0x10]
        # Hex Dump
        if len(data) == 16:
            for hex_dump in data:
                print("%02X" % hex_dump, end=' ')
        else:
            for hex_dump in data:
                print("%02X" % hex_dump, end=' ')

            for i in range(len(data), 16, 1):
                print("00", end=' ')
        if ((len(buffer) - offset) < 0x10) is True:
            print(' ' * (3 * (0x10 - len(data))), end='')
        offset = offset + len(data)
        print('  ')


def convertAndSave(array,name):
    root = '/upload'
    if array.shape[1]!=16: #If not hexadecima
        assert(False)
    b=int((array.shape[0]*16)**(0.5))
    b=2**(int(math.log(b)/math.log(2))+1)
    a=int(array.shape[0]*16/b)
    array=array[:a*b//16,:]
    array=np.reshape(array,(a,b))
    im = Image.fromarray(np.uint8(array))
    im.save(root+'\\'+name+'.png', "PNG")
    return im


@app.route('/')
def hello():
    return 'hello'

@app.route('/upload', methods=['POST','GET'])
def fileUpload():
    if request.method == 'POST':
        if 'file' not in request.files:
            flash('No file part')
            #return redirect(request.url)
            return 'File이 없어'

        file = request.files['file']
        # if user does not select file, browser also
        # submit an empty part without filename
        if file.filename == '':
            flash('No selected file')
            return 'filename = 이야'

        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(os.path.join(app.config['UPLOAD_FOLDER'], secure_filename(file.filename)))
            with open(os.path.join(app.config['UPLOAD_FOLDER'], filename),'rb') as ff:
                sys.stdout = open('/upload/output100.bytes', 'w')
                t = ff.read()
                print_hex_dump(t)
                sys.stdout = sys.__stdout__
                files = os.listdir('/upload')
                return str(files)
                for counter, name in enumerate(files):
                    if '.bytes' != name[-6:]:
                        continue
                    afterHex =  open('/upload/output100.bytes', 'r')
                    array = []
                    for line in afterHex:
                        xx = line.split()
                        if len(xx)!=17:
                            continue
                        array.append([int(i,16) if i!='??' else 0 for i in xx[1:] ])
                    im = convertAndSave(np.array(array),name)
                    del array
                    afterHex.close()

                #os.remove('/upload/output100.bytes')
                img_width = 150
                img_height = 150
                model = load_model('/upload/malware_classifier2.h5')
                model.compile(loss='binary_crossentropy',
                              optimizer='Adam',
                              metrics=['acc'])
                img = im
                x = image.img_to_array(img)
                x = cv2.resize(x, (img_width, img_height))
                x = cv2.cvtColor(x, cv2.COLOR_GRAY2BGR)
                x = np.expand_dims(x, axis=0)

                images = np.vstack([x])
                predict = model.predict(images)
                predict = np.argmax(predict,axis=1)

                if predict[0] == 0:
                    return '정상파일입니다.'
                elif predict[0] == 1:
                    return '악성파일입니다.'
            
                #return str(files)
            # return redirect(url_for('uploaded_file',
            #                         filename=filename))

           

    elif request.method == 'GET':
        return 'This is GET'
        

if __name__ == "__main__":  
    app.secret_key = os.urandom(24)
    app.run(debug=True,host="localhost", port=8000, use_reloader=False)


